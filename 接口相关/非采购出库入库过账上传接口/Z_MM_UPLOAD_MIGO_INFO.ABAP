FUNCTION Z_MM_UPLOAD_MIGO_INFO.
*"----------------------------------------------------------------------
*"*"本地接口：
*"  IMPORTING
*"     REFERENCE(INPUT) TYPE  ZMT_WMS2SAP_OTHERS
*"  EXPORTING
*"     REFERENCE(OUTPUT) TYPE  ZMT_WMS2SAP_OTHERS_RET
*"----------------------------------------------------------------------
  DATA: LS_HEADER TYPE ZDT_WMS2SAP_OTHERS,
        LT_ITEM   TYPE ZDT_WMS2SAP_OTHERS_SUB_TAB,
        LS_ITEM   TYPE ZDT_WMS2SAP_OTHERS_SUB,
        LS_OUT    TYPE ZDT_WMS2SAP_OTHERS_RET,
        LT_RET    TYPE ZDT_WMS2SAP_OTHERS_RET_LIS_TAB,
        LS_RET    TYPE ZDT_WMS2SAP_OTHERS_RET_LIST_OF,
        LT_NOPUR  TYPE STANDARD TABLE OF ZMMMIGO_NOPUR,
        LS_NOPUR  TYPE ZMMMIGO_NOPUR,
        LV_FLAG1  TYPE C,
        LV_FLAG2  TYPE C.

  CLEAR: LS_HEADER, LT_ITEM, LS_ITEM, LS_OUT, LT_RET, LS_RET.

  LS_HEADER = INPUT-MT_WMS2SAP_OTHERS.
  LT_ITEM = LS_HEADER-LIST_OF_OTHERS_POST.

  " 数据检查
  IF LT_ITEM IS INITIAL.
    LS_OUT-WMS_CUSTID = LS_HEADER-WMS_CUSTID.
    LS_OUT-WMS_DOCNO = LS_HEADER-WMS_DOCNO.
    LS_OUT-RET_CODE = 'E'.
    LS_OUT-RET_MSG = '无数据'.
    OUTPUT-MT_WMS2SAP_OTHERS_RET = LS_OUT.
    EXIT.
  ELSE.
    IF LS_HEADER-WMS_CUSTID IS INITIAL
      OR LS_HEADER-WMS_DOCNO IS INITIAL
      OR LS_HEADER-WERKS IS INITIAL
      OR LS_HEADER-OPERATOR IS INITIAL.
      LS_OUT-WMS_CUSTID = LS_HEADER-WMS_CUSTID.
      LS_OUT-WMS_DOCNO = LS_HEADER-WMS_DOCNO.
      LS_OUT-RET_CODE = 'E'.
      LS_OUT-RET_MSG = 'WMS货主ID/WMS单据号/工厂/操作员，不能为空'.
      OUTPUT-MT_WMS2SAP_OTHERS_RET = LS_OUT.
      EXIT.
    ELSE.
      LOOP AT LT_ITEM INTO LS_ITEM WHERE WMS_ITEMNO IS INITIAL OR MATNR IS INITIAL OR BUDAT IS INITIAL
                                      OR MENGE IS INITIAL OR MEINS IS INITIAL OR BWART IS INITIAL.
      ENDLOOP.
      IF SY-SUBRC = 0.
        LS_OUT-WMS_CUSTID = LS_HEADER-WMS_CUSTID.
        LS_OUT-WMS_DOCNO = LS_HEADER-WMS_DOCNO.
        LS_OUT-RET_CODE = 'E'.
        LS_OUT-RET_MSG = 'WMS单据行号/物料号/日期/数量/计量单位/移动类型，不能为空'.
        OUTPUT-MT_WMS2SAP_OTHERS_RET = LS_OUT.
        EXIT.
      ENDIF.
    ENDIF.
  ENDIF.

  " 重复性检查
  SELECT SINGLE * FROM ZMMMIGO_NOPUR INTO LS_NOPUR
    WHERE SAPNOTE_NO = LS_HEADER-SAPNOTE_NO.
  IF SY-SUBRC = 0.
    LS_OUT-WMS_CUSTID = LS_HEADER-WMS_CUSTID.
    LS_OUT-WMS_DOCNO = LS_HEADER-WMS_DOCNO.
    LS_OUT-RET_CODE = 'E'.
    CONCATENATE LS_HEADER-WMS_DOCNO '/' LS_HEADER-SAPNOTE_NO '已经过账，请勿重复'INTO LS_OUT-RET_MSG.
    OUTPUT-MT_WMS2SAP_OTHERS_RET = LS_OUT.
    EXIT.
  ENDIF.

  " 判断是否同时存在寄售和自有
  CLEAR: LV_FLAG1, LV_FLAG2.
*  LOOP AT LT_ITEM INTO LS_ITEM.
  LOOP AT LT_ITEM INTO LS_ITEM WHERE LIFNR IS NOT INITIAL.
    IF LS_ITEM-BWART = 'Z11'
      OR LS_ITEM-BWART = '201'
      OR LS_ITEM-BWART = 'Y61'
      OR LS_ITEM-BWART = 'Z61'.
*      OR LS_ITEM-BWART = '343'
*      OR LS_ITEM-BWART = '344'.
      LV_FLAG1 = 'X'.
    ENDIF.
*    IF LS_ITEM-BWART = '411' AND LS_ITEM-SOBKZ = 'K'.
*      LV_FLAG2 = 'X'.
*    ENDIF.
  ENDLOOP.
  IF LV_FLAG1 IS NOT INITIAL.
    " 移动类型为Z11/201/Y61/Z61，同时发寄售库存和自有库存，先将寄售库存转为自有库存（411/K），再用原移动类型过账
    PERFORM FRM_MIGO_JS USING LS_HEADER CHANGING LS_OUT.
  ELSE.
    LOOP AT LT_ITEM INTO LS_ITEM WHERE BWART = '101' OR BWART = '102'.
    ENDLOOP.
    IF SY-SUBRC = 0.
      " 成品入库
      PERFORM FRM_MIGO_CP USING LS_HEADER CHANGING LS_OUT.
    ELSE.
      PERFORM FRM_MIGO_OTHER USING LS_HEADER CHANGING LS_OUT.
    ENDIF.
  ENDIF.

  OUTPUT-MT_WMS2SAP_OTHERS_RET = LS_OUT.

*  MODIFY ZMMMIGO_NOPUR FROM TABLE LT_NOPUR.
ENDFUNCTION.